worker_processes auto;
worker_rlimit_nofile 65535;

events
{
	worker_connections 1024;
	multi_accept on;
}

http
{
	include mime.types;
	default_type application/octet-stream;

	# Оптимизация производительности
	sendfile on;
	tcp_nopush on;
	tcp_nodelay on;
	keepalive_timeout 65;
	keepalive_requests 100;

	# Настройка буферов
	client_body_buffer_size 128k;
	client_header_buffer_size 1k;
	large_client_header_buffers 4 4k;
	client_max_body_size 50M;

	# Безопасность
	server_tokens off;

	# Сжатие
	gzip on;
	gzip_vary on;
	gzip_proxied any;
	gzip_comp_level 6;
	gzip_min_length 1000;
	gzip_types
	text/plain
	text/css
	text/xml
	text/javascript
	application/json
	application/javascript
	application/xml+rss
	application/atom+xml
	image/svg+xml
	application/x-font-ttf
	font/opentype;

	# Блокировка любых неопределённых серверов
	server
	{
		listen 80 default_server;
		server_name _;
		return 444;
	}

	# HTTP сервер для bonix-auto.by
	server
	{
		listen 80;
		server_name bonix-auto.by;

		location ~ /\.well-known/acme-challenge
		{
			allow all;
			root D:/bonix-sites/nginx/site_bonix-auto_FrontEnd;
		}

		location /shared/geojson
		{
			root D:/bonix-sites/nginx;
			try_files /geojson.html =404;
		}

		location /
		{
			return 301 https://$host$request_uri;
		}
	}

	# HTTP сервер для bonix.by
	server
	{
		listen 80;
		server_name bonix.by;

		location ~ /\.well-known/acme-challenge
		{
			allow all;
			root D:/bonix-sites/nginx/site_bonix_FrontEnd;
		}

		location /
		{
			return 301 https://$host$request_uri;
		}
	}

	# HTTPS сервер для bonix.by
	server
	{
		listen 443 ssl;
		server_name bonix.by;

		# SSL настройки
		ssl_certificate D:/bonix-sites/nginx/ssl/bonix.by-chain.pem;
		ssl_certificate_key D:/bonix-sites/nginx/ssl/bonix.by-key.pem;
		ssl_protocols TLSv1.2 TLSv1.3;
		ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
		ssl_prefer_server_ciphers off;
		ssl_session_cache shared:SSL:10m;
		ssl_session_timeout 10m;

		# Заголовки безопасности
		add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
		add_header X-Frame-Options "SAMEORIGIN" always;
		add_header X-XSS-Protection "1; mode=block" always;
		add_header X-Content-Type-Options "nosniff" always;
		add_header Referrer-Policy "strict-origin-when-cross-origin" always;

		root D:/bonix-sites/nginx/site_bonix_FrontEnd;
		index index.html;

		# Обработка ошибок
		error_page 404 /404.html;
		location = /404.html
		{
			root D:/bonix-sites/nginx;
		}

		location = /404
		{
			root D:/bonix-sites/nginx;
			try_files /404.html =404;
			return 404;
		}

		location ~ /\.well-known/acme-challenge
		{
			allow all;
		}

		# IT раздел с авторизацией
		location = /it
		{
			return 301 $scheme://$host$request_uri/;
		}

		location ^~ /it/
		{
			alias D:/ArchiMate/Site/;

			location ~* \.(woff2|woff|ttf|eot|svg|css|js|png|jpg|jpeg|gif|ico|json)$
			{
				expires 7d;
				add_header Cache-Control "public, max-age=604800, must-revalidate";
				add_header Vary "Accept-Encoding";
				auth_basic off;
				try_files $uri =404;
			}

			auth_basic "Restricted Area";
			auth_basic_user_file D:/bonix-sites/nginx/.htpasswd;
			add_header Cache-Control "no-store, no-cache, must-revalidate";
			add_header X-Robots-Tag "noindex, nofollow" always;

			if ($request_uri ~ ^/it/.+\.\w+/)
			{
				return 301 $scheme://$host$uri;
			}

			try_files $uri $uri/ /it/index.html;
		}

		# Кэширование медиа файлов
		location ~* \.(ico|gif|jpg|jpeg|png|svg|webp)$
		{
			expires 3d;
			add_header Cache-Control "public, max-age=259200, must-revalidate";
			add_header Vary "Accept-Encoding";
		}

		location ~* \.(woff|woff2|ttf|otf|eot)$
		{
			expires 1y;
			add_header Cache-Control "public, immutable";
			add_header Access-Control-Allow-Origin "*";
		}

		# Reports проксирование
		location /reports
		{
			rewrite ^/reports$ /reports/ break;
			proxy_pass http://185.66.69.32/reports;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
			proxy_pass_request_headers on;
			proxy_redirect default;
			proxy_connect_timeout 180s;
			proxy_send_timeout 180s;
			proxy_read_timeout 180s;
			proxy_buffer_size 128k;
			proxy_buffers 4 256k;
			proxy_busy_buffers_size 256k;
			client_max_body_size 0;
		}

		# API проксирование
		location /api
		{
			proxy_pass http://localhost:3001;
			proxy_http_version 1.1;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Socket.IO
		location /socket.io/
		{
			proxy_pass http://localhost:3001/socket.io/;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Основная обработка запросов
		location /
		{
			set $prerender 0;

			if ($http_user_agent ~* "googlebot|googlebot-image|googlebot-video|googlebot-news|adsbot-google|bingbot|msnbot|baiduspider|yandexbot|yandeximages|yandexvideo|yandexmobilebot|yeti|facebookexternalhit|twitterbot|telegrambot|slackbot|linkedinbot|pinterestbot|applebot|duckduckbot|ahrefsbot|semrushbot|ia_archiver|developers\.google\.com|redditbot|discordbot")
			{
				set $prerender 1;
			}
			if ($args ~ "_escaped_fragment_")
			{
				set $prerender 1;
			}
			if ($http_user_agent ~ "Prerender")
			{
				set $prerender 0;
			}
			if ($uri ~* "^/(robots\.txt|sitemap\.xml)$")
			{
				set $prerender 0;
			}

			# Проксирование для prerender
			if ($prerender = 1)
			{
				proxy_pass http://192.168.34.113:3000/render/$scheme://$host$request_uri;
				break;
			}

			try_files $uri $uri/ /index.html;
		}
	}

	# HTTPS сервер для bonix-auto.by
	server
	{
		listen 443 ssl;
		server_name bonix-auto.by;

		# SSL настройки
		ssl_certificate D:/bonix-sites/nginx/ssl/bonix-auto.by-crt.pem;
		ssl_certificate_key D:/bonix-sites/nginx/ssl/bonix-auto.by-key.pem;
		ssl_protocols TLSv1.2 TLSv1.3;
		ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
		ssl_prefer_server_ciphers off;
		ssl_session_cache shared:SSL:10m;
		ssl_session_timeout 10m;

		# Заголовки безопасности
		add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
		add_header Content-Security-Policy "frame-ancestors 'self' https://2cjckgw6qyqne.elma365.ru https://bonix.elma365.ru";
		add_header X-Frame-Options "SAMEORIGIN" always;
		add_header X-XSS-Protection "1; mode=block" always;
		add_header X-Content-Type-Options "nosniff" always;
		add_header Referrer-Policy "strict-origin-when-cross-origin" always;

		root D:/bonix-sites/nginx/site_bonix_FrontEnd;
		index index.html;

		# Обработка ошибок
		error_page 404 /404.html;
		location = /404.html
		{
			root D:/bonix-sites/nginx;
		}

		location = /404
		{
			root D:/bonix-sites/nginx;
			try_files /404.html =404;
			return 404;
		}

		location ~ /\.well-known/acme-challenge
		{
			allow all;
		}

		location /shared/geojson
		{
			root D:/bonix-sites/nginx;
			try_files /geojson.html =404;
		}

		# Кэширование медиа файлов
		location ~* \.(ico|gif|jpg|jpeg|png|svg|webp)$
		{
			expires 3d;
			add_header Cache-Control "public, max-age=259200, must-revalidate";
			add_header Vary "Accept-Encoding";
		}

		location ~* \.(woff|woff2|ttf|otf|eot)$
		{
			expires 1y;
			add_header Cache-Control "public, immutable";
			add_header Access-Control-Allow-Origin "*";
		}

		# API проксирование
		location /api/
		{
			proxy_pass http://localhost:3000;
			proxy_http_version 1.1;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Socket.IO
		location /socket.io/
		{
			proxy_pass http://localhost:3000/socket.io/;
			proxy_http_version 1.1;
			proxy_set_header Upgrade $http_upgrade;
			proxy_set_header Connection "upgrade";
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_set_header X-Forwarded-Proto $scheme;
		}

		# Основная обработка запросов
		location /
		{
			set $prerender 0;
				proxy_connect_timeout 180s;
				proxy_send_timeout 180s;
				proxy_read_timeout 180s;
				proxy_pass http://localhost:3005/prerender-html-only/$scheme://$host$request_uri;

		}
	}
}